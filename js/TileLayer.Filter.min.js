/*
 @preserve Leaflet Tile Filters, a JavaScript plugin for apply image filters to tile images
 (c) 2014, Scott Fairgrieve, HumanGeo
*/
L.Color=L.Class.extend({initialize:function(e){this._rgb=[0,0,0],this._hsl=[0,1,.5],this._a=1,e&&this.parseColorDef(e)},parseColorDef:function(){},rgbToHSL:function(e,t,n){e/=255,t/=255,n/=255;var r,a,i=Math.max(e,t,n),s=Math.min(e,t,n),l=(i+s)/2;if(i==s)r=a=0;else{var o=i-s;switch(a=l>.5?o/(2-i-s):o/(i+s),i){case e:r=(t-n)/o+(n>t?6:0);break;case t:r=(n-e)/o+2;break;case n:r=(e-t)/o+4}r/=6}return[r,a,l]},hslToRGB:function(e,t,n){function r(e,t,n){return 0>n&&(n+=1),n>1&&(n-=1),1/6>n?e+6*(t-e)*n:.5>n?t:2/3>n?e+6*(t-e)*(2/3-n):e}var a,i,s;if(0==t)a=i=s=n;else{var l=.5>n?n*(1+t):n+t-n*t,o=2*n-l;a=r(o,l,e+1/3),i=r(o,l,e),s=r(o,l,e-1/3)}return[Math.floor(255*a),Math.floor(255*i),Math.floor(255*s)]},setRGB:function(e,t,n){return this._rgb=[e,t,n],this._hsl=this.rgbToHSL(e,t,n),this},setHSL:function(e,t,n){return this._hsl=[e,t,n],this._rgb=this.hslToRGB(e,t,n),this},toHSL:function(){return this._hsl},toHSLString:function(){var e="hsl";return 1>this._a&&(e+="a"),e+"("+(360*this._hsl[0]).toFixed(1)+","+(100*this._hsl[1]).toFixed(0)+"%,"+(100*this._hsl[2]).toFixed(0)+"%)"},toRGB:function(){return this._rgb},toRGBString:function(){var e;if(1>this._a)e="rgba("+this._rgb[0].toFixed(0)+","+this._rgb[1].toFixed(0)+","+this._rgb[2].toFixed(0)+","+this._a.toFixed(1)+")";else{for(var t=[this._rgb[0].toString(16),this._rgb[1].toString(16),this._rgb[2].toString(16)],n=0;t.length>n;++n)1===t[n].length&&(t[n]="0"+t[n]);e="#"+t.join("")}return e},r:function(e){return arguments.length?this.setRGB(e,this._rgb[1],this._rgb[2]):this._rgb[0]},g:function(e){return arguments.length?this.setRGB(this._rgb[0],e,this._rgb[2]):this._rgb[1]},b:function(e){return arguments.length?this.setRGB(this._rgb[0],this._rgb[1],e):this._rgb[2]},h:function(e){return arguments.length?this.setHSL(e,this._hsl[1],this._hsl[2]):this._hsl[0]},s:function(e){return arguments.length?this.setHSL(this._hsl[0],e,this._hsl[2]):this._hsl[1]},l:function(e){return arguments.length?this.setHSL(this._hsl[0],this._hsl[1],e):this._hsl[2]},a:function(e){return arguments.length?(this._a=e,this):this._a}}),L.RGBColor=L.Color.extend({initialize:function(e){L.Color.prototype.initialize.call(this,e)},parseColorDef:function(e){var t,n,r,a,i=e instanceof Array,s=0===e.indexOf("#"),l=[];i?(t=Math.floor(e[0]),n=Math.floor(e[1]),r=Math.floor(e[2]),a=4===e.length?e[3]:1):s?(e=e.replace("#",""),t=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),r=parseInt(e.substring(4,6),16),a=8===e.length?parseInt(e.substring(6,8),16):1):(l=e.replace("rgb","").replace("a","").replace(/\s+/g,"").replace("(","").replace(")","").split(","),t=parseInt(l[0]),n=parseInt(l[1]),r=parseInt(l[2]),a=4===l.length?parseInt(l[3]):1),this.setRGB(t,n,r),this._a=a}}),L.rgbColor=function(e){return new L.RGBColor(e)},L.ImageFilter=L.Class.extend({initialize:function(e,t){this._image=e,L.Util.setOptions(this,t)},render:function(){return this}}),L.CanvasFilter=L.ImageFilter.extend({render:function(){var e;this._image.canvasContext||(e=document.createElement("canvas"),e.width=e.height=this._image._layer.options.tileSize,this._image.canvasContext=e.getContext("2d"));var t=this._image.canvasContext;if(t){var n=this.options.channelFilter||function(e){return e};t.drawImage(this._image,0,0);var r=t.getImageData(0,0,this._image._layer.options.tileSize,this._image._layer.options.tileSize);r=n.call(this._image,r),t.putImageData(r,0,0),this._image.onload=null,this._image.removeAttribute("crossorigin"),this._image._layer.options.canvasFilter?this._image._layer.options.canvasFilter.call(this):this._image.src=e.toDataURL()}return this}}),L.CanvasChannelFilter=L.Class.extend({options:{opacity:255},initialize:function(e,t){this._imageData=e,L.Util.setOptions(this,t)},setOpacity:function(e){this.options.opacity=e},updateChannels:function(e){return e[3]=this.options.opacity,e},render:function(){for(var e=this._imageData.data,t=0,n=e.length;n>t;t+=4)for(var r=this.updateChannels([e[t],e[t+1],e[t+2],e[t+3]]),a=0;4>a;++a)e[t+a]=r[a];return this._imageData}}),L.CanvasChannelFilters={},L.CanvasChannelFilters.Grayscale=L.CanvasChannelFilter.extend({options:{channelWeights:[3,4,1]},initialize:function(e,t){L.CanvasChannelFilter.prototype.initialize.call(this,e,t),this.sumWeights()},sumWeights:function(){for(var e=0,t=0;3>t;++t)e+=this.options.channelWeights[t];this._summedWeight=e},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);var t=this.options.channelWeights;return e[0]=e[1]=e[2]=(t[0]*e[0]+t[1]*e[1]+t[2]*e[2])/this._summedWeight,e}}),L.CanvasChannelFilters.Threshold=L.CanvasChannelFilters.Grayscale.extend({options:{channelWeights:[3,4,1],thresholds:[128,128,128,128],trueValues:[255,255,255,255],falseValues:[0,0,0,255]},initialize:function(e,t){L.CanvasChannelFilters.Grayscale.prototype.initialize.call(this,e,t)},updateChannels:function(e){e=L.CanvasChannelFilters.Grayscale.prototype.updateChannels.call(this,e);for(var t=0;4>t;++t)e[t]=e[t]>=this.options.thresholds[t]?this.options.trueValues[t]:this.options.falseValues[t];return e}}),L.CanvasChannelFilters.Contrast=L.CanvasChannelFilter.extend({options:{contrast:0,factor:function(e){return 255*(255+e)/(255*(255-e))}},initialize:function(e,t){L.CanvasChannelFilter.prototype.initialize.call(this,e,t),this._factor=this.options.factor.call(this,this.options.contrast)},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);for(var t=0;3>t;++t)e[t]=this._factor*(e[t]-128)+128;return e}}),L.CanvasChannelFilters.Invert=L.CanvasChannelFilter.extend({updateChannels:function(e){L.CanvasChannelFilter.prototype.updateChannels.call(this,e);for(var t=0;3>t;++t)e[t]=255-e[t];return e}}),L.CanvasChannelFilters.ChannelSwap=L.CanvasChannelFilter.extend({options:{positions:[0,1]},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);var t=e[this.options.positions[0]];return e[this.options.positions[0]]=e[this.options.positions[1]],e[this.options.positions[1]]=t,e}}),L.CanvasChannelFilters.Matrix=L.CanvasChannelFilter.extend({options:{matrix:[.393,.769,.189,.349,.686,.168,.272,.534,.131]},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);for(var t=this.options.matrix,n=e[0],r=e[1],a=e[2],i=0;3>i;++i)e[i]=n*t[3*i]+r*t[3*i+1]+a*t[3*i+2];return e}}),L.CanvasChannelFilters.Sepia=L.CanvasChannelFilters.Matrix.extend({options:{matrix:[.393,.769,.189,.349,.686,.168,.272,.534,.131]}}),L.CanvasChannelFilters.FilterChain=L.CanvasChannelFilter.extend({options:{filters:[]},setFilters:function(e){return this.options.filters=e,this},clearFilters:function(){return this.options.filters=[],this},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);for(var t=this.options.filters,n=0;t.length>n;++n)e=t[n].call(this,e);return e}}),L.CanvasChannelFilters.Adjust=L.CanvasChannelFilter.extend({options:{adjustments:[20,20,20]},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);for(var t=0;3>t;++t)e[t]=Math.min(Math.max(e[t]+this.options.adjustments[t],0),255);return e}}),L.CanvasChannelFilters.HSLAdjust=L.CanvasChannelFilter.extend({options:{adjustments:[30,0,0]},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);var t=new L.RGBColor([e[0],e[1],e[2],e[3]]);t.setHSL((360*t._hsl[0]+this.options.adjustments[0])/360,t._hsl[1]+this.options.adjustments[1],t._hsl[2]+this.options.adjustments[2]);for(var n=0;3>n;++n)e[n]=t._rgb[n];return this.options.adjustments.length>3&&(e[3]+=this.options.adjustments[3]),t=null,e}}),L.CanvasChannelFilters.Colorize=L.CanvasChannelFilter.extend({options:{channel:0,values:[0,0]},updateChannels:function(e){e=L.CanvasChannelFilter.prototype.updateChannels.call(this,e);var t=[0,1,2];t.splice(this.options.channel,1);var n=e[0],r=e[1],a=e[2];return e[this.options.channel]=(n+r+a)/3,e[t[0]]=this.options.values[0],e[t[1]]=this.options.values[1],e}}),L.CSSFilter=L.ImageFilter.extend({statics:{prefixes:["-webkit-","-moz-","-ms-","-o-",""]},render:function(){for(var e=0;L.CSSFilter.prefixes.length>e;++e)this._image.style.cssText+=" "+L.CSSFilter.prefixes[e]+"filter: "+this.options.filters.join(" ")+";"}}),L.CombinedFilter=L.ImageFilter.extend({setCanvasFilter:function(e){return this.options.channelFilter=e,this.render()},setCSSFilter:function(e){return this.options.cssFilter=e,this.render()},render:function(){var e=L.CanvasFilter.prototype.render.call(this);this.options.cssFilter&&this.options.cssFilter.call(e._image)}}),L.ImageFilters={},L.ImageFilters.GenerateCSSFilter=function(e){return function(){return new L.CSSFilter(this,{filters:e}).render()}},L.ImageFilters.Presets={CSS:{None:function(){return this},Brightness200:L.ImageFilters.GenerateCSSFilter(["brightness(200%)"]),Brightness180:L.ImageFilters.GenerateCSSFilter(["brightness(180%)"]),Brightness160:L.ImageFilters.GenerateCSSFilter(["brightness(160%)"]),Brightness140:L.ImageFilters.GenerateCSSFilter(["brightness(140%)"]),Brightness120:L.ImageFilters.GenerateCSSFilter(["brightness(120%)"]),Brightness100:L.ImageFilters.GenerateCSSFilter(["brightness(100%)"]),Brightness80:L.ImageFilters.GenerateCSSFilter(["brightness(80%)"]),Brightness60:L.ImageFilters.GenerateCSSFilter(["brightness(60%)"]),Brightness40:L.ImageFilters.GenerateCSSFilter(["brightness(40%)"]),Brightness20:L.ImageFilters.GenerateCSSFilter(["brightness(20%)"]),Contrast200:L.ImageFilters.GenerateCSSFilter(["contrast(200%)"]),Contrast180:L.ImageFilters.GenerateCSSFilter(["contrast(180%)"]),Contrast160:L.ImageFilters.GenerateCSSFilter(["contrast(160%)"]),Contrast140:L.ImageFilters.GenerateCSSFilter(["contrast(140%)"]),Contrast120:L.ImageFilters.GenerateCSSFilter(["contrast(120%)"]),Contrast100:L.ImageFilters.GenerateCSSFilter(["contrast(100%)"]),Contrast80:L.ImageFilters.GenerateCSSFilter(["contrast(80%)"]),Contrast60:L.ImageFilters.GenerateCSSFilter(["contrast(60%)"]),Contrast40:L.ImageFilters.GenerateCSSFilter(["contrast(40%)"]),Contrast20:L.ImageFilters.GenerateCSSFilter(["contrast(20%)"]),Sepia100:L.ImageFilters.GenerateCSSFilter(["sepia(100%)"]),Sepia80:L.ImageFilters.GenerateCSSFilter(["sepia(80%)"]),Sepia60:L.ImageFilters.GenerateCSSFilter(["sepia(60%)"]),Sepia40:L.ImageFilters.GenerateCSSFilter(["sepia(40%)"]),Sepia20:L.ImageFilters.GenerateCSSFilter(["sepia(20%)"]),Saturate200:L.ImageFilters.GenerateCSSFilter(["saturate(200%)"]),Saturate300:L.ImageFilters.GenerateCSSFilter(["saturate(300%)"]),Saturate400:L.ImageFilters.GenerateCSSFilter(["saturate(400%)"]),Saturate500:L.ImageFilters.GenerateCSSFilter(["saturate(500%)"]),Saturate600:L.ImageFilters.GenerateCSSFilter(["saturate(600%)"]),Saturate700:L.ImageFilters.GenerateCSSFilter(["saturate(700%)"]),Invert100:L.ImageFilters.GenerateCSSFilter(["invert(100%)"]),Invert80:L.ImageFilters.GenerateCSSFilter(["invert(80%)"]),Invert60:L.ImageFilters.GenerateCSSFilter(["invert(60%)"]),Invert40:L.ImageFilters.GenerateCSSFilter(["invert(40%)"]),Invert20:L.ImageFilters.GenerateCSSFilter(["invert(20%)"]),HueRotate30:L.ImageFilters.GenerateCSSFilter(["hue-rotate(30deg)"]),HueRotate60:L.ImageFilters.GenerateCSSFilter(["hue-rotate(60deg)"]),HueRotate90:L.ImageFilters.GenerateCSSFilter(["hue-rotate(90deg)"]),HueRotate120:L.ImageFilters.GenerateCSSFilter(["hue-rotate(120deg)"]),HueRotate150:L.ImageFilters.GenerateCSSFilter(["hue-rotate(150deg)"]),HueRotate180:L.ImageFilters.GenerateCSSFilter(["hue-rotate(180deg)"]),HueRotate210:L.ImageFilters.GenerateCSSFilter(["hue-rotate(210deg)"]),HueRotate240:L.ImageFilters.GenerateCSSFilter(["hue-rotate(240deg)"]),HueRotate270:L.ImageFilters.GenerateCSSFilter(["hue-rotate(270deg)"]),HueRotate300:L.ImageFilters.GenerateCSSFilter(["hue-rotate(300deg)"]),HueRotate330:L.ImageFilters.GenerateCSSFilter(["hue-rotate(330deg)"])},CanvasChannel:{None:function(e){return e},Grayscale1:function(e){return new L.CanvasChannelFilters.Grayscale(e).render()},Grayscale2:function(e){return new L.CanvasChannelFilters.Grayscale(e,{weights:[1,1,1]}).render()},Grayscale3:function(e){return new L.CanvasChannelFilters.Grayscale(e,{weights:[1,2,3]}).render()},HueRotate30:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[30,0,0]}).render()},HueRotate60:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[60,0,0]}).render()},HueRotate90:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[90,0,0]}).render()},HueRotate120:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[120,0,0]}).render()},HueRotate150:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[150,0,0]}).render()},HueRotate180:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[180,0,0]}).render()},HueRotate210:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[210,0,0]}).render()},HueRotate240:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[240,0,0]}).render()},HueRotate270:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[270,0,0]}).render()},HueRotate300:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[300,0,0]}).render()},HueRotate330:function(e){return new L.CanvasChannelFilters.HSLAdjust(e,{adjustments:[330,0,0]}).render()},Sepia1:function(e){return new L.CanvasChannelFilters.Sepia(e).render()},Invert:function(e){return new L.CanvasChannelFilters.Invert(e).render()},ColorizeRed:function(e){return new L.CanvasChannelFilters.Colorize(e,{channel:0,values:[0,0]}).render()},ColorizeGreen:function(e){return new L.CanvasChannelFilters.Colorize(e,{channel:1,values:[0,0]}).render()},ColorizeBlue:function(e){return new L.CanvasChannelFilters.Colorize(e,{channel:2,values:[0,0]}).render()}}},L.ImageFilterFunctions={__loadTile:L.TileLayer.prototype._loadTile,__tileOnLoad:L.TileLayer.prototype._tileOnLoad,setFilter:function(e){return this.options.filter=e,this.redraw()},clearFilter:function(){return this.options.filter=null,this.redraw()},_tileOnLoad:function(){var e=this._layer.options.filter;e&&e.call(this),this._layer.__tileOnLoad.call(this)},_loadTile:function(e,t){e.setAttribute("crossorigin","anonymous"),this.__loadTile.call(this,e,t)}},L.TileLayer.include(L.ImageFilterFunctions);